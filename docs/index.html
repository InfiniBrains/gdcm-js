<html>
<head>
    <noscript>
        Sorry...JavaScript is needed to go ahead.
    </noscript>
    <script language = "javascript" type = "text/javascript">
        var fileList = [];
        var memfs=[];
        var fileId = 0;

        var consume = function(){
            // consume
            console.log(fileList);
            var file = fileList[fileId];

            // read
            var reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onloadend = function(evt) {
                memfs.push({name: file.name, data: new Uint8Array(evt.target.result)});
                console.log(memfs);

                fileId++;
                if(fileId>fileList.length-1)
                    setTimeout(runEmscripten, 0);
                else
                    setTimeout(consume, 0);
            };
        };

        var runEmscripten = function () {
            console.log("run baby");
            var arguments = document.getElementById("arguments").value.split(" ");

            var stdout = "";
            var stderr = "";
            var worker = new Worker("../gdcmanon.js");
            worker.onmessage = function(e) {
                var msg = e.data;
                switch (msg.type) {
                    case "ready":
                        worker.postMessage({type: "run", arguments: arguments, MEMFS:memfs});
                        break;
                    case "resolve":
                        console.log(msg.MEMFS);
                        break;
                    case "stdout":
                        stdout += msg.data + "\n";
                        break;
                    case "stderr":
                        stderr += msg.data + "\n";
                        break;
                    case "exit":
                        console.log("Process exited with code " + msg.data);
                        console.log(stdout);
                        worker.terminate();
                        break;
                }
            };
        };

        function process() {
            fileId=0;
            fileList = document.getElementById("inputfiles").files;
            consume();
        }
    </script>
</head>
<body>
<h1>This demo covers the Anonimation from GDCM ported to JS.</h1>
Drag DICOM(s) file(s) to this button or click it to select the files:<br>
<input id="inputfiles" type="file"   value="Select Files " multiple="multiple"> <br>
Type your arguments that you wish to pass to gdcmanon:
<input id="arguments" type="text"   title="arguments" name="fname" value="--dumb --remove 400,500 --remove 12,62 --remove 12,63 input.dcm output.dcm"><br>
<input id="submit"    type="button" value="Process"       onclick="process();" /> <br>

</body>
</html>